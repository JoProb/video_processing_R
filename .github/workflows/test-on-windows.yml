name: Test R Script on Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: windows-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v4

    - name: Set up R
      uses: r-lib/actions/setup-r@v2

    - name: Install FFmpeg
      run: choco install ffmpeg -y

    - name: Prepare test environment
      run: |
        # Create an input directory for the test
        mkdir in_vids
        # Create a dummy video file for the script to process
        ffmpeg -f lavfi -i testsrc=size=320x240:rate=10 -t 3 in_vids/test_video.mp4
        # Temporarily update the script to use the relative 'in_vids' directory
        powershell -Command "(Get-Content process_videos.R) -replace '/run/media/jonas/LaCie/DATA/sample_reference_vids/', 'in_vids' | Set-Content process_videos.R"
      shell: pwsh

    - name: Run video processing script
      run: Rscript process_videos.R
      shell: pwsh

    - name: Verify output
      run: |
        echo "Contents of output directory:"
        ls out
        # Check if the processed file exists
        if (-not (Test-Path out/test_video_r.mp4)) {
          echo "Output file 'out/test_video_r.mp4' not found!"
          exit 1
        }
        echo "Output file found. Test successful."
      shell: pwsh
